<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>reactivity</title>
  </head>
  <body>
    <button onclick="handleAddX()">addX</button>
    <button onclick="handleAddY()">addY</button>

    <script>
      const targetMap = new WeakMap()

      const obj = reactive({ xx: 1, yy: 2, zz: 0 })
      const effect = () => {
        obj.zz = obj.xx * obj.yy
        console.log(`obj====`, obj)
      }
      effect()

      function reactive(target) {
        const handler = {
          get(target, key, receiver) {
            let value = Reflect.get(target, key, receiver)
            track(target, key)
            return value
          },
          set(target, key, value, receiver) {
            let oldValue = target[key]
            if (oldValue !== value) {
              trigger(target, key)
            }
            let res = Reflect.set(target, key, value, receiver)
            return res
          },
        }
        const proxyTarget = new Proxy(target, handler)
        return proxyTarget
      }

      function track(target, key) {
        let depsMap = targetMap.get(target)
        if (!depsMap) targetMap.set(target, (depsMap = new Map()))
        let deps = depsMap.get(key)
        if (!deps) depsMap.set(key, (deps = new Set()))
        deps.add(effect)
      }

      function trigger(target, key) {
        const depsMap = targetMap.get(target)
        if (!depsMap) return
        const deps = depsMap.get(key)
        if (deps) {
          deps.forEach((effect) => {
            effect()
          })
        }
      }

      const handleAddX = () => {
        obj.xx++
      }

      const handleAddY = () => {
        obj.yy++
      }
    </script>
  </body>
</html>
