<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mount</title>
    <style>
      .red {
        color: red;
      }

      .green {
        color: green;
      }
    </style>
  </head>
  <body>
    <div id="app"></div>

    <script>
      function h(tag, props, children) {
        return { tag, props, children }
      }

      function mount(vnode, container) {
        const { tag, props, children } = vnode
        const el = (vnode.el = document.createElement(tag))
        if (props) {
          for (let key in props) {
            let val = props[key]
            el.setAttribute(key, val)
          }
        }

        if (typeof children === 'string') el.textContent = children
        else if (children?.length > 0) children.forEach((child) => mount(child, el))

        container.append(el)
      }

      function patchProps(n1, n2) {
        const el = n1.el
        const oldProps = n1.props
        const newProps = n2.props
        if (oldProps && newProps) {
          for (let key in newProps) {
            let oldVal = oldProps[key]
            let newVal = newProps[key]
            if (oldVal !== newVal) el.setAttribute(key, newVal)
          }

          for (let key in oldProps) {
            if (!(key in newProps)) el.removeAttribute(key)
          }
        } else if (oldProps) {
          for (let key in oldProps) {
            el.removeAttribute(key)
          }
        } else if (newProps) {
          for (let key in newProps) {
            let val = newProps[key]
            el.setAttribute(key, val)
          }
        }
      }

      function patchChildren(n1, n2) {
        const el = n1.el
        const oldChildren = n1.children
        const newChildren = n2.children

        if (typeof oldChildren === 'string') {
          if (typeof newChildren === 'string') {
            if (oldChildren !== newChildren) el.textContent = newChildren
          } else {
            el.innerHtml = ''
            newChildren.forEach((child) => mount(chlid, el))
          }
        } else {
          if (typeof newChildren === 'string') el.textContent = newChildren
          else {
            let oldLen = oldChildren.length
            let newLen = newChildren.length
            let commonLen = Math.min(oldLen, newLen)
            for (let i = 0; i < commonLen; i++) {
              patch(oldChildren[i], newChildren[i])
            }
            if (newLen > oldLen) {
              newChildren.slice(oldLen).forEach((child) => mount(child, el))
            } else if (newLen < oldLen) {
              oldChildren.slice(newLen).forEach((child) => el.removeChild(child.el))
            }
          }
        }
      }

      function patch(n1, n2) {
        const el = n1.el
        if (n2.tag === n1.tag) {
          patchProps(n1, n2)
          patchChildren(n1, n2)
        } else {
          let parent = el.parentNode
          parent.removeChild(el)
          mount(n2, parent)
        }
      }

      const vdom = h('div', { class: 'red' }, [h('span', null, 'hello'), h('span', null, 'xxx')])

      const vdom2 = h('div', { class: 'green' }, [h('span', null, 'world')])

      mount(vdom, document.querySelector('#app'))

      patch(vdom, vdom2)
    </script>
  </body>
</html>
